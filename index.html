<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Atlas of Everyday Istanbul — Iframe Build</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Exotic font for splash and map UI -->
  <link href="https://fonts.googleapis.com/css2?family=Marcellus+SC&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Darker, higher contrast palette */
      --bg: #161920;
      --panel: #232635;
      --text: #f2efe9;
      --muted: #a3adc4;
      --brand: #e96e36;
      --highlight: #39b7b1;
      --outline: #403b3b;
      --accent: #ffbe7b;
      --map-card-bg: #232635;
      --map-card-border: #2c2f3a;
      --map-card-hover: #24293a;
      --legend-bg: #232635f7;
      --footer-bg: #232635e8;
      --footer-text: #f2efe9;
      /* Splash theme - use same darks */
      --splash-bg: #181a21;
      --splash-title: #e96e36;
      --splash-sub: #f2efe9;
      --splash-bar-bg: #2c2f3a;
      --splash-bar-fill: linear-gradient(90deg,#e96e36 0%,#39b7b1 100%);
      --splash-glow: 0 0 32px #e96e3688;
      --splash-font-title: 'Marcellus SC', serif;
      --splash-font-sub: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }
    html, body {
      height:100%; margin:0;
      background: var(--bg);
      color: var(--text);
      font-family: var(--splash-font-sub);
    }
    .wrap {
      display:grid; grid-template-columns:340px 1fr; height:100%;
      background: var(--bg);
    }
    #sidebar {
      background:var(--panel);
      border-right:2px solid var(--outline);
      overflow:auto;
      font-family: var(--splash-font-sub);
    }
    #map { height:100%; width:100%; }
    .brand {
      padding:18px 18px 10px;
      border-bottom:2px solid var(--outline);
      background: var(--map-card-bg);
    }
    .brand h1 {
      font-size:22px;
      margin:0 0 7px;
      color: var(--brand);
      font-family: var(--splash-font-title);
      letter-spacing: .03em;
      font-weight: 700;
      text-shadow: 0 1px 10px #e96e3636;
    }
    .brand p {
      margin:0;
      font-size:13px;
      color: var(--muted);
      font-family: var(--splash-font-sub);
      font-weight: 400;
    }
    .list { padding:10px 10px 24px; }
    .card {
      background: var(--map-card-bg);
      border:2px solid var(--map-card-border);
      border-radius:14px;
      padding:13px;
      margin:12px 8px;
      cursor:pointer;
      transition:transform .15s, background .15s, box-shadow .2s;
      box-shadow: 0 4px 16px #181a2138;
      font-family: var(--splash-font-sub);
    }
    .card:hover {
      background:var(--map-card-hover);
      transform: translateY(-1px) scale(1.017);
      box-shadow: 0 8px 20px #e96e363a;
      border-color: var(--brand);
    }
    .title {
      font-family: var(--splash-font-title);
      font-weight:700;
      font-size:15.5px;
      margin-bottom:3px;
      color: var(--brand);
      letter-spacing: 0.02em;
      text-shadow: 0 2px 10px #181a214a;
    }
    .meta {
      color:var(--muted);
      font-size:12.5px;
      font-family: var(--splash-font-sub);
    }
    .leaflet-popup-content { margin:10px; }
    .pin-title {
      margin:0 0 6px;
      font-size:18px;
      font-weight:700;
      color:var(--brand);
      font-family: var(--splash-font-title);
      letter-spacing:0.03em;
      text-shadow: 0 2px 10px #181a2130;
    }
    .pin-body {
      margin:0 0 8px;
      font-size:14px;
      line-height:1.5;
      color:var(--splash-sub);
      font-family: var(--splash-font-sub);
    }
    .pin-meta {
      font-size:12px;
      color: #ffbe7b;
      font-family: var(--splash-font-sub);
    }
    .legend {
      position:absolute; z-index:500; right:16px; top:16px;
      background:var(--legend-bg);
      border-radius:14px;
      padding:10px 16px;
      color:var(--splash-sub);
      font-size:13px;
      border:2px solid var(--outline);
      font-family: var(--splash-font-sub);
      box-shadow: 0 4px 16px #181a2135;
    }
    .footer {
      position:absolute; z-index:500; left:360px; bottom:12px;
      background:var(--footer-bg);
      color:var(--footer-text);
      font-size:13px;
      padding:8px 14px;
      border-radius:12px;
      border: 2px solid var(--outline);
      font-family: var(--splash-font-sub);
      box-shadow: 0 2px 8px #181a2118;
    }
    @media (max-width:900px){
      .wrap{ grid-template-columns:1fr }
      #sidebar{ height:42% }
      #map{ height:58% }
      .footer{ left:10px }
    }
    .btn-ambient {
      display:inline-block;
      font:inherit;
      background: var(--highlight);
      color: #fff;
      border:0;
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-family: var(--splash-font-sub);
      font-weight: 600;
      letter-spacing: 0.01em;
      box-shadow: 0 1px 4px #181a2120;
    }
    .btn-ambient:hover { filter: brightness(1.08); }
    .amb-note { font-size:12px; color:var(--highlight); margin-top:6px; }
    .ist-pin { border:0; background:transparent; }
    .ist-pin .pin {
      position:relative;
      width:36px; height:36px; border-radius:12px;
      background: var(--brand, #e96e36);
      display:grid; place-items:center;
      box-shadow:0 6px 14px #181a213a, inset 0 0 0 1.5px #e96e3630;
    }
    .ist-pin .pin::after {
      content:"";
      position:absolute; left:50%; bottom:-8px;
      transform:translateX(-50%) rotate(45deg);
      width:14px; height:14px;
      background:var(--brand,#e96e36);
      box-shadow:2px 2px 8px #181a2110;
      border-radius:4px;
    }
    .ist-pin .glyph { font-size:18px; filter: drop-shadow(0 1px 1px #181a2135); }
    /* Splash overlay styles */
    #intro-overlay {
      position:fixed; inset:0;
      background:var(--splash-bg);
      display:flex; align-items:center; justify-content:center;
      z-index:3000;
      color:var(--splash-title);
      font-family: var(--splash-font-title);
      box-shadow:inset 0 0 0 3px #e96e3633;
      transition: background 0.7s;
    }
    #intro-overlay .inner {
      text-align:center;
      font-weight:800;
      letter-spacing:.04em;
      max-width: 540px;
      margin:0 auto;
      padding:38px 30px 38px 30px;
      background: rgba(35,38,53,0.98);
      border-radius: 28px;
      box-shadow: var(--splash-glow);
      border: 2.5px solid #e96e36;
    }
    #intro-overlay h2 {
      font-family: var(--splash-font-title);
      font-size:clamp(2.1rem,7vw,3.4rem);
      margin:0 0 0.8rem 0;
      color: var(--splash-title);
      letter-spacing: 0.01em;
      font-weight:900;
      text-shadow: 0 2px 18px #e96e3633;
    }
    #intro-overlay .subtitle {
      font-family: var(--splash-font-sub);
      font-size:clamp(1.1rem,2.4vw,1.5rem);
      margin:0 0 1.5rem 0;
      color:var(--splash-sub);
      font-weight:600;
      letter-spacing:0.01em;
      text-shadow: 0 1px 10px #10101244;
    }
    #intro-overlay .desc {
      font-family: var(--splash-font-sub);
      font-size:1.06rem;
      color:#ffe1bf;
      margin:0 0 1.7rem 0;
      font-weight:400;
      letter-spacing:0.02em;
    }
    #intro-overlay .loading-bar-wrap {
      width: min(320px, 70vw);
      margin: 2.1rem auto 0;
      height: 13px;
      background: var(--splash-bar-bg);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 12px #181a213a;
      border: 1.5px solid #e96e36;
      position: relative;
      display: block;
    }
    #intro-overlay .loading-bar {
      height: 100%;
      width: 0%;
      background: var(--splash-bar-fill);
      border-radius: 8px;
      transition: width 0s;
      box-shadow: 0 0 10px #e96e3633 inset;
    }
    /* Leaflet tooltip and popup theme for dark mode */
    .leaflet-tooltip,
    .leaflet-popup-content-wrapper,
    .leaflet-popup-tip {
      background: #232635 !important;
      color: #ffbe7b !important;
      border-radius: 12px !important;
      border: 2px solid #e96e36 !important;
      box-shadow: 0 4px 24px #000a, 0 1.5px 0 #181a21;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }
    .leaflet-tooltip {
      color: #f2efe9 !important;
      border: 2px solid #39b7b1 !important;
      background: #181a21e6 !important;
      font-size: 14px;
      padding: 6px 13px;
      font-family: 'Marcellus SC', serif;
      font-weight: 600;
      letter-spacing: 0.01em;
      box-shadow: 0 2px 8px #10101299;
    }
    .leaflet-popup-content {
      color: #f2efe9 !important;
      font-size: 15px;
      font-family: 'Marcellus SC', serif;
      letter-spacing: 0.01em;
    }
    .leaflet-popup-close-button {
      color: #ffbe7b !important;
      text-shadow: none !important;
      font-size: 24px !important;
      opacity: 0.8 !important;
    }
    .leaflet-popup-close-button:hover {
      color: #e96e36 !important;
      opacity: 1 !important;
    }
    @media (prefers-reduced-motion:no-preference){ .flash{animation:flash 1s step-end infinite} }
    @media (prefers-reduced-motion:reduce){ .flash{animation:none} }
    @keyframes flash{50%{opacity:0}}
  </style>
</head>
<body>
  <!-- 5s intro splash; fades out automatically -->
  <div id="intro-overlay" role="dialog" aria-label="Intro">
    <div class="inner">
      <h2 class="flash">“My Istanbul”</h2>
      <div class="subtitle">C-LAB FALL 2025 PROJECT</div>
      <div class="desc">
        A collaborative atlas of Istanbul created by New Media &amp; Communication students.<br>
        Explore everyday places, memory, and diversity—each pin tells a personal story.
      </div>
      <div class="loading-bar-wrap" aria-label="Loading">
        <div class="loading-bar" id="intro-loading-bar"></div>
      </div>
      <audio id="intro-midi" loop style="display:none">
        <source src="https://upload.wikimedia.org/wikipedia/commons/5/5e/Turkish-Arabic-folk-tune-short.ogg" type="audio/ogg">
        <source src="https://upload.wikimedia.org/wikipedia/commons/5/5e/Turkish-Arabic-folk-tune-short.ogg" type="audio/mpeg">
      </audio>
    </div>
  </div>
  <div class="wrap">
    <aside id="sidebar">
      <div class="brand">
        <h1>Atlas of Everyday Istanbul</h1>
        <p>Demo map • Click a card to fly to a story pin.</p>
      </div>
      <div class="list" id="pinList"></div>
    </aside>
    <main id="map"></main>
  </div>
  <div class="legend">Use mouse/trackpad to pan/zoom • Click pins for stories</div>
  <div class="footer">Iframe build • All assets over HTTPS • No CMS hooks required</div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    'use strict';

    // Helpers
    const nl2br = (s='') => String(s).replace(/\n/g, '<br>');
    const defaultIconSpec = { glyph:'📍', color:'#e96e36' };

    // One-media-per-pin demo content
    const pins = [
      // ...pins data unchanged...
      { id:'kumkapi', coords:[41.0019,28.9616], location:'Kumkapı Fish Market, Fatih', icon:{glyph:'🐟',color:'#4fd1c5'},
        title:'From Armenian Taverns to Syrian Seafood Stalls',
        text:`Kumkapı has long been a meeting point of cultures in Istanbul. In the early 20th century, the neighborhood was famous for its Armenian taverns, where mezes and music mixed with political debate. 

Since 2011, Syrian families have opened small seafood restaurants tucked between fish stalls. Their menus combine Levantine spices with the traditional Turkish meze spread. A waiter told us: “People come for the fish, but stay to talk.”`,
        meta:'Languages: TR • AR • HY • Collected: Mar 2025 • Consent: public space, no faces',
        ambient:[
          { label:'Seagulls', volume:0.35, loop:true, sources:[
            {src:'https://upload.wikimedia.org/wikipedia/commons/4/43/Gull_1.ogg', type:'audio/ogg'},
            {src:'https://upload.wikimedia.org/wikipedia/commons/transcoded/4/43/Gull_1.ogg/Gull_1.ogg.mp3?download=', type:'audio/mpeg'}
          ]},
          { label:'Waves', volume:0.25, loop:true, sources:[
            {src:'https://upload.wikimedia.org/wikipedia/commons/1/1f/Waves.ogg', type:'audio/ogg'},
            {src:'https://upload.wikimedia.org/wikipedia/commons/transcoded/1/1f/Waves.ogg/Waves.ogg.mp3?download=', type:'audio/mpeg'}
          ]},
          { label:'Restaurant ambience', volume:0.2, loop:true, sources:[
            {src:'https://upload.wikimedia.org/wikipedia/commons/b/b5/Restaurant_ambience.ogg', type:'audio/ogg'},
            {src:'https://upload.wikimedia.org/wikipedia/commons/transcoded/b/b5/Restaurant_ambience.ogg/Restaurant_ambience.ogg.mp3?download=', type:'audio/mpeg'}
          ]}
        ]
      },
      // ...other pins unchanged...
      { id:'moda', coords:[40.9838,29.0252], location:'Moda Sahili, Kadıköy', icon:{glyph:'🌊',color:'#60a5fa'},
        title:'Where Languages Mix with the Sound of Waves',
        text:`On summer evenings, the Moda seaside becomes a gathering point for young Syrians, Kurds, Greeks, and expats. Conversations flow in Arabic, Turkish, English, and occasionally Greek. For many, the sound of waves is the only constant.`,
        meta:'Languages: TR • AR • EN • Collected: Apr 2025 • Consent: distant crowd photo',
        video:'https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.webm'
      },
      // ... (rest of pins unchanged) ...
      { id:'kurtulus', coords:[41.0536,28.9888], location:'Kurtuluş (Tatavla), Şişli', icon:{glyph:'🏘️',color:'#f59e0b'},
        title:'Layers of Memory in a Changing Neighborhood',
        text:`Known historically as Tatavla, Kurtuluş has long-standing Greek and Armenian roots. Today, it also hosts migrants from across Anatolia and the Middle East. Bakeries sell paskalya çöreği next to börek shops run by new arrivals.`,
        meta:'Languages: TR • HY • EN • Collected: Mar 2025 • Consent: interview excerpts anonymized',
        image:'https://picsum.photos/id/1062/800/480'
      },
      { id:'balat', coords:[41.0343,28.9497], location:'Balat, Fatih', icon:{glyph:'🏛️',color:'#c084fc'},
        title:'Between Heritage and Instagram',
        text:`Balat’s colorful facades attract visitors, but behind the photos are synagogues, churches, and long-standing Jewish, Greek, and Armenian histories. New cafes run by recent migrants add to the mix.`,
        meta:'Languages: TR • AR • legacy: HY • EL • Collected: Apr 2025 • Consent: no private interiors',
        image:'https://picsum.photos/id/1043/800/480'
      },
      { id:'uskudar', coords:[41.0257,29.0153], location:'Üsküdar İskele Meydanı', icon:{glyph:'🕌',color:'#34d399'},
        title:'Transit Square, Shared Rituals',
        text:`At ferry time, Üsküdar Square becomes a choreography of commuters, street vendors, and worshippers moving to and from nearby mosques and churches. Tea sellers switch languages with ease.`,
        meta:'Languages: TR • AR • EN • Collected: May 2025 • Consent: public space, wide shots only',
        image:'https://picsum.photos/id/1056/800/480'
      },
      { id:'karakoy_pier', coords:[41.0226,28.9784], location:'Karaköy İskelesi, Beyoğlu', icon:{glyph:'⛴️',color:'#22d3ee'},
        title:'Crossing Currents: Ferries, Fish, and Faith',
        text:`Between the pier and the fish stalls, Karaköy mixes office workers, tourists, and long-time residents. Calls to prayer blend with ferry announcements; seagulls circle above simit sellers.`,
        meta:'Languages: TR • EN • AR • Collected: May 2025 • Consent: public waterfront',
        video:'https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.webm'
      },
      { id:'spice_bazaar', coords:[41.0165,28.9704], location:'Mısır Çarşısı (Spice Bazaar), Eminönü', icon:{glyph:'🧂',color:'#f87171'},
        title:'Aromas and Accents under the Domes',
        text:`Vendors chant prices in Turkish and English, switching to Arabic or Russian when needed. Tourists bargain for saffron while locals pick up staples. The vaulted hall carries a constant murmur of voices.`,
        meta:'Languages: TR • EN • AR • RU • Collected: May 2025 • Consent: indoor public, wide shots',
        ambient:[
          { label:'Restaurant ambience', volume:0.25, loop:true, sources:[
            {src:'https://upload.wikimedia.org/wikipedia/commons/b/b5/Restaurant_ambience.ogg', type:'audio/ogg'},
            {src:'https://upload.wikimedia.org/wikipedia/commons/transcoded/b/b5/Restaurant_ambience.ogg/Restaurant_ambience.ogg.mp3?download=', type:'audio/mpeg'}
          ]}
        ]
      },
      { id:'besiktas_market', coords:[41.0430,29.0048], location:'Beşiktaş Çarşısı', icon:{glyph:'🧺',color:'#facc15'},
        title:'Morning Rush, Nighttime Cheers',
        text:`From fishmonger shouts to evening chants after a big match, Beşiktaş’s market streets are a study in daily rhythms. Students, workers, and fans share pavements; Kurdish bakeries and Greek tavernas operate side by side.`,
        meta:'Languages: TR • KU • EN • Collected: May 2025 • Consent: street scenes only',
        image:'https://picsum.photos/id/1003/800/480'
      }
    ];

    // Map setup
    const map = L.map('map', { zoomControl:false }).setView([41.02,28.98], 12);
    L.control.zoom({ position:'topright' }).addTo(map);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'&copy; OpenStreetMap contributors' }).addTo(map);

    // Icon factory
    function makeIcon(spec){
      const glyph = (spec && spec.glyph) || defaultIconSpec.glyph;
      const color = (spec && spec.color) || defaultIconSpec.color;
      return L.divIcon({ className:'ist-pin', html:`<div class="pin" style="--pin:${color}"><span class="glyph">${glyph}</span></div>`, iconSize:[36,44], iconAnchor:[18,44], popupAnchor:[0,-36] });
    }

    // Markers (unchanged)
    const markerById = new Map();
    pins.forEach(p => {
      const m = L.marker(p.coords, { icon: makeIcon(p.icon) }).addTo(map);
      let media = '';
      if (p.video) media += `<div style="margin:8px 0"><video controls preload="none" style="width:100%;max-height:220px"><source src="${p.video}">Your browser does not support the video tag.</video></div>`;
      if (p.image) media += `<div style="margin:8px 0"><img src="${p.image}" alt="${p.title}" style="width:100%;height:auto;border-radius:10px;display:block" loading="lazy"></div>`;
      let ambientUi = '';
      if (p.ambient && p.ambient.length) {
        const labels = p.ambient.map(t=>t.label).join(', ');
        ambientUi = `<div id="amb-${p.id}"><button class="btn-ambient" type="button">Play ambience</button><div class="amb-note">Mix: ${labels}. Click to start. (Loops; stops on close.)</div><div class="amb-audios" data-ready=""></div></div>`;
      }
      m.bindPopup(`<h3 class="pin-title">${p.title}</h3><div class="pin-body">${nl2br(p.text)}</div>${media}${ambientUi}<div class="pin-meta"><b>Location:</b> ${p.location}<br>${p.meta}</div>`);
      m.on('popupopen', (e)=>{
        if (!(p.ambient && p.ambient.length)) return;
        const root = e.popup._contentNode.querySelector(`#amb-${p.id}`); if (!root) return;
        const holder = root.querySelector('.amb-audios');
        if (!holder.dataset.ready) {
          p.ambient.forEach(tr => { const a = document.createElement('audio'); a.preload='none'; a.loop=!!tr.loop; a.volume=(typeof tr.volume==='number'?tr.volume:0.3); a.crossOrigin='anonymous'; (tr.sources||[]).forEach(s=>{const src=document.createElement('source'); src.src=s.src; src.type=s.type; a.appendChild(src)}); holder.appendChild(a); }); holder.dataset.ready = "1";
        }
        const btn = root.querySelector('.btn-ambient'); const audios = Array.from(holder.querySelectorAll('audio')); let playing=false;
        btn.onclick = async ()=>{ try { if(!playing){ await Promise.all(audios.map(a=>a.play())); playing=true; btn.textContent='Pause ambience'; } else { audios.forEach(a=>a.pause()); playing=false; btn.textContent='Play ambience'; } } catch(e){} }
      });
      markerById.set(p.id, m);
    });

    // Fit bounds & media cleanup
    const group = new L.featureGroup([...markerById.values()]); map.fitBounds(group.getBounds().pad(0.2));
    map.on('popupclose', (e) => {
      const node = e.popup && e.popup._contentNode;
      if (!node) return;
      node.querySelectorAll('audio, video').forEach(el => {
        try { el.pause(); el.currentTime = 0; } catch(_) {}
      });
    });

    // --- Intro overlay logic with sound on first interaction ---
    (function(){
      const overlay = document.getElementById('intro-overlay');
      if (!overlay) return;
      let dismissed = false;
      let played = false;
      const midi = document.getElementById('intro-midi');
      // Animate loading bar over 5s
      const bar = document.getElementById('intro-loading-bar');
      if (bar) {
        bar.style.transition = 'width 5s linear';
        setTimeout(()=>{ bar.style.width = '100%'; }, 30);
      }
      // Play melody on first user interaction (anywhere)
      function handleUserGesture() {
        if (!played && midi) {
          midi.volume = 1.0;
          midi.play().catch(()=>{});
          played = true;
        }
        window.removeEventListener('pointerdown', handleUserGesture);
        window.removeEventListener('keydown', handleUserGesture);
      }
      window.addEventListener('pointerdown', handleUserGesture, { once:true });
      window.addEventListener('keydown', handleUserGesture, { once:true });

      function dismiss(){
        if (dismissed) return; dismissed = true;
        // Fade out the audio if it was played
        if (midi && played) {
          let v = midi.volume;
          const fade = setInterval(()=>{
            v -= 0.07;
            if(v <= 0) { midi.volume = 0; midi.pause(); clearInterval(fade);}
            else midi.volume = v;
          }, 40);
        }
        overlay.style.transition = 'opacity 600ms ease';
        overlay.style.opacity = '0';
        setTimeout(()=> overlay.remove(), 650);
      }
      setTimeout(dismiss, 5000);
    })();

    // Sidebar
    const list = document.getElementById('pinList');
    pins.forEach((p,i)=>{ const el=document.createElement('div'); el.className='card'; el.innerHTML=`<div class="title">${i+1}. ${p.title}</div><div class="meta">${p.location}</div>`; el.onclick=()=>{ markerById.get(p.id).openPopup(); map.setView(p.coords,16,{animate:true,duration:.6}); }; list.appendChild(el); });

    // Console tests (sanity)
    (function(){ const name='Iframe Build Tests'; console.groupCollapsed(name);
      const keys=['video','image','ambient']; pins.forEach(p=>{ const c=keys.reduce((a,k)=>a+ (k==='ambient' ? (p.ambient&&p.ambient.length?1:0) : (p[k]?1:0)),0); console.assert(c<=1, `${p.id} should only have one media type`); });
      console.assert(markerById.size===pins.length, 'one marker per pin');
      console.assert(document.getElementById('map'), '#map exists');
      console.assert(typeof L==='object' && L.map, 'Leaflet loaded');
      console.groupEnd(name); })();
  </script>
</body>
</html>
