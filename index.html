<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Atlas of Everyday Istanbul — Iframe Build</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Albert+Sans:wght@400;600;700&family=Barlow:wght@400;600;700&family=Marcellus+SC&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #161920;
      --panel: #232635;
      --text: #f2efe9;
      --muted: #a3adc4;
      --brand: #e96e36;
      --highlight: #39b7b1;
      --outline: #403b3b;
      --accent: #ffbe7b;
      --map-card-bg: #232635;
      --map-card-border: #2c2f3a;
      --map-card-hover: #24293a;
      --legend-bg: #232635f7;
      --footer-bg: #232635e8;
      --footer-text: #f2efe9;
      --splash-bg: #181a21;
      --splash-title: #e96e36;
      --splash-sub: #f2efe9;
      --splash-bar-bg: #2c2f3a;
      --splash-bar-fill: linear-gradient(90deg,#e96e36 0%,#39b7b1 100%);
      --splash-glow: 0 0 32px #e96e3688;
      --splash-font-title: 'Marcellus SC', serif;
      --splash-font-sub: 'Albert Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
      --ui-font: 'Albert Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
      --heading-font: 'Barlow', 'Albert Sans', Arial, sans-serif;
    }
    html, body { height:100%; margin:0; background: var(--bg); color: var(--text); font-family: var(--ui-font); }
    .wrap { display:grid; grid-template-columns:340px 1fr; height:100vh; background: var(--bg); }
    #sidebar { background:var(--panel); border-right:2px solid var(--outline); overflow:auto; font-family: var(--ui-font); }
    #map { height:100vh; width:100%; }
    .brand { padding:18px 18px 10px; border-bottom:2px solid var(--outline); background: var(--map-card-bg); }
    .brand h1 { font-size:22px; margin:0 0 7px; color: var(--brand); font-family: var(--heading-font); letter-spacing: .03em; font-weight: 700; text-shadow: 0 1px 10px #e96e3636; }
    .brand p { margin:0; font-size:13px; color: var(--muted); font-family: var(--ui-font); font-weight: 400; }
    .list { padding:10px 10px 24px; }
    .card { background: var(--map-card-bg); border:2px solid var(--map-card-border); border-radius:14px; padding:13px; margin:12px 8px; cursor:pointer; transition:transform .15s, background .15s, box-shadow .2s; box-shadow: 0 4px 16px #181a2138; font-family: var(--ui-font); }
    .card:hover, .card.active { background:var(--map-card-hover); transform: translateY(-1px) scale(1.017); box-shadow: 0 8px 20px #e96e363a; border-color: var(--brand); }
    .title { font-family: var(--heading-font); font-weight:700; font-size:15.5px; margin-bottom:3px; color: var(--brand); letter-spacing: 0.02em; text-shadow: 0 2px 10px #181a214a; }
    .meta { color:var(--muted); font-size:12.5px; font-family: var(--ui-font); }
    .leaflet-popup-content { margin:10px; }
    .pin-title { margin:0 0 6px; font-size:18px; font-weight:700; color:var(--brand); font-family: var(--heading-font); letter-spacing:0.03em; text-shadow: 0 2px 10px #181a2130; }
    .pin-body { margin:0 0 8px; font-size:14px; line-height:1.5; color:var(--splash-sub); font-family: var(--ui-font); }
    .pin-meta { font-size:12px; color: #ffbe7b; font-family: var(--ui-font); }
    .legend { position:absolute; z-index:500; right:16px; top:16px; background:var(--legend-bg); border-radius:14px; padding:10px 16px; color:var(--splash-sub); font-size:13px; border:2px solid var(--outline); font-family: var(--ui-font); box-shadow: 0 4px 16px #181a2135; }
    .footer { position:absolute; z-index:500; left:360px; bottom:12px; background:var(--footer-bg); color:var(--footer-text); font-size:13px; padding:8px 14px; border-radius:12px; border: 2px solid var(--outline); font-family: var(--ui-font); box-shadow: 0 2px 8px #181a2118; }
    @media (max-width:900px){ .wrap{ grid-template-columns:1fr } #sidebar{ height:42% } #map{ height:58% } .footer{ left:10px } }
    .btn-ambient { display:inline-block; font:inherit; background: var(--highlight); color: #fff; border:0; padding:8px 12px; border-radius:10px; cursor:pointer; font-family: var(--ui-font); font-weight: 600; letter-spacing: 0.01em; box-shadow: 0 1px 4px #181a2120; transition: background .15s, opacity .15s; }
    .btn-ambient:disabled { opacity: 0.5; pointer-events: none; }
    .btn-ambient:hover { filter: brightness(1.08); }
    .amb-note { font-size:12px; color:var(--highlight); margin-top:6px; }
    .ist-pin { border:0; background:transparent; }
    .ist-pin .pin { position:relative; width:36px; height:36px; border-radius:12px; background: var(--brand, #e96e36); display:grid; place-items:center; box-shadow:0 6px 14px #181a213a, inset 0 0 0 1.5px #e96e3630; }
    .ist-pin .pin::after { content:""; position:absolute; left:50%; bottom:-8px; transform:translateX(-50%) rotate(45deg); width:14px; height:14px; background:var(--brand,#e96e36); box-shadow:2px 2px 8px #181a2110; border-radius:4px; }
    .ist-pin .glyph { font-size:18px; filter: drop-shadow(0 1px 1px #181a2135); }
    #intro-overlay { position:fixed; inset:0; background:var(--splash-bg); display:flex; align-items:center; justify-content:center; z-index:3000; color:var(--splash-title); font-family: var(--splash-font-title); box-shadow:inset 0 0 0 3px #e96e3633; transition: background 0.7s; }
    #intro-overlay .inner { text-align:center; font-weight:800; letter-spacing:.04em; max-width: 540px; margin:0 auto; padding:38px 30px; background: rgba(35,38,53,0.98); border-radius: 28px; box-shadow: var(--splash-glow); border: 2.5px solid #e96e36; }
    #intro-overlay h2 { font-family: var(--splash-font-title); font-size:clamp(2.1rem,7vw,3.4rem); margin:0 0 0.8rem 0; color: var(--splash-title); letter-spacing: 0.01em; font-weight:900; text-shadow: 0 2px 18px #e96e3633; }
    #intro-overlay .subtitle { font-family: var(--heading-font); font-size:clamp(1.1rem,2.4vw,1.5rem); margin:0 0 1.5rem 0; color:var(--splash-sub); font-weight:600; letter-spacing:0.01em; text-shadow: 0 1px 10px #10101244; }
    #intro-overlay .desc { font-family: var(--ui-font); font-size:1.06rem; color:#ffe1bf; margin:0 0 1.7rem 0; font-weight:400; letter-spacing:0.02em; }
    #intro-overlay .loading-bar-wrap { width: min(320px, 70vw); margin: 2.1rem auto 0; height: 13px; background: var(--splash-bar-bg); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 12px #181a213a; border: 1.5px solid #e96e36; position: relative; display: block; transition: opacity 0.3s; }
    #intro-overlay .loading-bar { height: 100%; width: 0%; background: var(--splash-bar-fill); border-radius: 8px; transition: width 5s linear; box-shadow: 0 0 10px #e96e3633 inset; display: block; }
    #press-any-key { display: none; margin: 2.1rem 0 0 0; font-family: var(--heading-font); font-size: 1.35rem; color: var(--highlight); letter-spacing: 0.06em; text-shadow: 0 2px 10px #181a218c; background: none; border: none; outline: none; cursor: pointer; padding: 0; font-weight: 700; animation: fadeIn 1.2s cubic-bezier(.23,.97,.52,1.09) both; }
    #second-overlay { position: fixed; inset: 0; z-index: 2999; background: rgba(35,38,53,0.98); display: none; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.6s; }
    #typewriter-text { color: #f2efe9; font-family: 'Albert Sans','Helvetica Neue',Arial,sans-serif; font-size: 1em; line-height: 1.65; letter-spacing: .01em; font-weight: 400; max-width: 66vw; min-width: 320px; margin: 0 auto; white-space: pre-wrap; word-break: break-word; overflow-wrap: break-word; padding: 5vh 2vw 2vh 2vw; min-height: 48vh; display: block; text-align: left; box-sizing: border-box; }
    #typewriter-text b { color: #ffbe7b; font-family: var(--heading-font); font-weight: bold; }
    #typewriter-text em { color: #39b7b1; font-style: italic; font-family: var(--heading-font); font-weight: 600; }
    #second-continue-btn { margin: 24px auto 0; font-size: 1em; display: block; }
    @media (max-width:900px) { #typewriter-text { max-width: 95vw; } }
    @media (max-width:700px) { #typewriter-text { font-size: 0.97em; max-width:98vw; min-height:32vh; padding: 2vh 2vw 2vh 2vw;} }
    .leaflet-tooltip,
    .leaflet-popup-content-wrapper,
    .leaflet-popup-tip {
      background: #181a21 !important; color: #ffe5c2 !important; border-radius: 12px !important; border: 2px solid #39b7b1 !important; box-shadow: 0 4px 24px #000a, 0 1.5px 0 #181a21; font-family: var(--ui-font) !important;
    }
    .leaflet-tooltip { color: #ffe5c2 !important; background: #181a21 !important; border: 2px solid #e96e36 !important; font-size: 15px; padding: 8px 16px; font-family: var(--heading-font) !important; font-weight: 700; letter-spacing: 0.01em; box-shadow: 0 2px 10px #181a21b9; text-shadow: 0 2px 8px #000a; }
    .leaflet-popup-content-wrapper, .leaflet-popup-tip { background: #1d2331 !important; color: #ffe5c2 !important; border-radius: 14px !important; border: 2px solid #39b7b1 !important; font-family: var(--ui-font) !important; box-shadow: 0 6px 24px #181a213a; }
    .leaflet-popup-content { color: #ffe5c2 !important; font-size: 15px; font-family: var(--heading-font) !important; letter-spacing: 0.01em; }
    .leaflet-popup-close-button { color: #ffbe7b !important; text-shadow: none !important; font-size: 26px !important; opacity: 0.88 !important; }
    .leaflet-popup-close-button:hover { color: #e96e36 !important; opacity: 1 !important; }
    @media (prefers-reduced-motion:no-preference){ .flash{animation:flash 1s step-end infinite} }
    @media (prefers-reduced-motion:reduce){ .flash{animation:none} }
    @keyframes flash{50%{opacity:0}}
  </style>
  <body>
    <!-- Music for both overlays (no loop, fades out after second overlay) -->
    <audio id="atlas-music" preload="auto" style="display:none">
      <source src="https://raw.githubusercontent.com/ivofurman/istanbul_atlas/main/Turku_Nomads_of_the_Silk_Road_-_01_-_-Uskudara_Gideriken.ogg" type="audio/ogg">
      Your browser does not support the audio element.
    </audio>

    <!-- First Splash Overlay -->
    <div id="intro-overlay" role="dialog" aria-label="Intro">
      <div class="inner">
        <h2 class="flash">“My Istanbul”</h2>
        <div class="subtitle">C-LAB FALL 2025 PROJECT</div>
        <div class="desc">
          A living atlas of Istanbul.<br>
          Explore everyday places, memory, and diversity—each pin tells a personal story.
        </div>
        <div class="loading-bar-wrap" aria-label="Loading" id="loading-bar-wrap">
          <div class="loading-bar" id="intro-loading-bar"></div>
        </div>
        <div id="press-any-key">Press any key to continue</div>
      </div>
    </div>

    <!-- Second Splash Overlay - fullscreen text -->
    <div id="second-overlay">
      <div id="typewriter-text" aria-label="Instructor message"></div>
      <button id="second-continue-btn" class="btn-ambient" style="display:none;">Press any key to continue</button>
    </div>

    <div class="wrap">
      <aside id="sidebar">
        <div class="brand">
          <h1>Atlas of Everyday Istanbul</h1>
          <p>Demo map • Click a card to fly to a story pin.</p>
        </div>
        <div class="list" id="pinList"></div>
      </aside>
      <main id="map"></main>
    </div>

    <div class="legend">Use mouse/trackpad to pan/zoom • Click pins for stories</div>
    <div class="footer">Iframe build • All assets over HTTPS • No CMS hooks required</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      // --- Typewriter message with bold and italics markup ---
      const typewriterMsg = `<b>Dear students,</b>

Unfortunately I cannot be with you today. Today’s meeting clashes with the first class of <em>MED 204</em> (thank you <b>Güventürk Hoca</b>!). So instead, I have prepared this text to introduce <b>“My Istanbul.”</b>

You will create content for an interactive digital map that tells the story of the city from your own perspective. Each of you will select meaningful places — a street corner, a café, a market, a square — and prepare a short narrative with one media element (<em>photo, audio, or video</em>).

My role is to guide you through the process and provide the <em>technical framework</em>; your role is to research, document, and reflect so the final project is both <b>thoughtful</b> and <b>engaging</b>.

On the next screen, you will find a <b>demo version</b> of the map that you can explore as a class.

<b>I look forward to seeing how you will represent your Istanbul.</b>

Best,
Ivo Furman`;

      // --- Second overlay typewriter logic with HTML support and word wrap ---
      function showSecondOverlay() {
        const secondOverlay = document.getElementById('second-overlay');
        const typewriterText = document.getElementById('typewriter-text');
        const secondBtn = document.getElementById('second-continue-btn');
        if (secondOverlay) {
          secondOverlay.style.display = 'flex';
          secondOverlay.style.opacity = '1';
          secondOverlay.style.flexDirection = 'column';
          secondOverlay.style.alignItems = 'center';
          secondOverlay.style.justifyContent = 'center';
          startTypewriter();
        }
        function startTypewriter() {
          let i = 0, html = '', tag = '', inTag = false;
          typewriterText.innerHTML = '';
          if (secondBtn) secondBtn.style.display = 'none';
          function typeChar() {
            if (i < typewriterMsg.length) {
              const c = typewriterMsg[i];
              if (c === '<') { inTag = true; tag = c; }
              else if (inTag) { tag += c; if (c === '>') { inTag = false; html += tag; tag=''; } }
              else { html += c; }
              typewriterText.innerHTML = html + (inTag ? '' : '<span style="opacity:0.22;">|</span>');
              i++;
              let delay = 56;
              if (c === "\n") delay = 350;
              else if (".!?".includes(c)) delay = 175;
              else if (",;:".includes(c)) delay = 100;
              setTimeout(typeChar, delay);
            } else {
              typewriterText.innerHTML = html;
              if (secondBtn) secondBtn.style.display = 'block';
              window.addEventListener('keydown', handleSecondOverlay, { once: true });
              window.addEventListener('pointerdown', handleSecondOverlay, { once: true });
            }
          }
          typeChar();
        }
        function handleSecondOverlay() {
          // 90-second fade-out of music
          const music = document.getElementById('atlas-music');
          if (music) {
            let fadeSteps = 90 * 10;
            let step = music.volume / fadeSteps;
            let fade = setInterval(() => {
              if (music.volume > step) {
                music.volume = Math.max(0, music.volume - step);
              } else {
                music.volume = 0;
                clearInterval(fade);
              }
            }, 100);
          }
          if (secondOverlay) {
            secondOverlay.style.opacity = '0';
            setTimeout(()=> { secondOverlay.style.display = 'none'; }, 650);
            window.removeEventListener('keydown', handleSecondOverlay);
            window.removeEventListener('pointerdown', handleSecondOverlay);
          }
        }
        if (secondBtn) secondBtn.onclick = handleSecondOverlay;
      }

      // --- Splash loading bar logic (with reliable animation) ---
      (function(){
        const overlay = document.getElementById('intro-overlay');
        if (!overlay) return;
        let loadingDone = false, dismissed = false, played = false;
        const music = document.getElementById('atlas-music');
        const pressAnyKey = document.getElementById('press-any-key');
        const loadingBarWrap = document.getElementById('loading-bar-wrap');
        const bar = document.getElementById('intro-loading-bar');
        if (bar) {
          bar.style.width = '0%';
          bar.style.transition = 'none';
          void bar.offsetWidth;
          bar.style.transition = 'width 5s linear';
          setTimeout(()=>{ bar.style.width = '100%'; }, 20);
        }
        function handleUserGesture() {
          if (!played && music) {
            music.volume = 1.0;
            music.play().catch(()=>{});
            played = true;
          }
          if (loadingDone && !dismissed && pressAnyKey.style.display === 'block') {
            dismiss();
          }
        }
        setTimeout(() => {
          loadingDone = true;
          if (loadingBarWrap) loadingBarWrap.style.display = 'none';
          if (pressAnyKey) pressAnyKey.style.display = 'block';
          window.addEventListener('keydown', handleUserGesture, { once:true });
          window.addEventListener('pointerdown', handleUserGesture, { once:true });
        }, 5000);
        function dismiss(){
          if (dismissed) return; dismissed = true;
          overlay.style.transition = 'opacity 600ms ease';
          overlay.style.opacity = '0';
          setTimeout(()=> {
            overlay.style.display = 'none';
            showSecondOverlay();
          }, 650);
          window.removeEventListener('keydown', handleUserGesture);
          window.removeEventListener('pointerdown', handleUserGesture);
        }
      })();

      // Helper for nl2br
      function nl2br(s='') { return String(s).replace(/\n/g, '<br>'); }

      // ---- Pins array ----
      const pins = [
        // Existing demo pins
        {
          id: 'galata_tower',
          coords: [41.0256, 28.9744],
          location: 'Galata Tower, Beyoğlu',
          icon: {glyph:'🗼', color:'#64748b'},
          title: 'Galata: Overlooking Centuries',
          text: `Galata Tower stands witness to the ever-changing cityscape of Istanbul. Locals and tourists gather here to watch the sunset and feel the pulse of both old and new Istanbul. Each stone in the tower seems to hold a story.`,
          meta: 'Languages: TR • EN • Collected: Sep 2025 • Consent: public square',
          image: 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=800&q=80'
        },
        {
          id: 'cengelkoy_tea',
          coords: [41.0532, 29.0541],
          location: 'Çengelköy Tea Gardens, Üsküdar',
          icon: {glyph:'🍵', color:'#22d3ee'},
          title: 'Çengelköy: Tea by the Bosphorus',
          text: `Morning and evening, tea gardens in Çengelköy fill with friends, families, and solitary thinkers. The clink of glasses and the view of boats passing by makes this a cherished communal ritual.`,
          meta: 'Languages: TR • EN • Collected: Aug 2025 • Consent: public outdoor seating',
          image: 'https://images.unsplash.com/photo-1504196606672-aef5c9cefc92?auto=format&fit=crop&w=800&q=80'
        },
        {
          id: 'kadikoy_street_art',
          coords: [40.991, 29.0281],
          location: 'Kadıköy Street Art, Kadıköy',
          icon: {glyph:'🎨', color:'#f472b6'},
          title: 'Walls that Speak: Kadıköy Murals',
          text: `Kadıköy’s side streets burst with color thanks to local and international artists. New murals appear overnight, reflecting the city’s youth, activism, and creativity.`,
          meta: 'Languages: TR • EN • Collected: Jun 2025 • Consent: street view, public art',
          image: 'https://images.unsplash.com/photo-1503676382389-4809596d5290?auto=format&fit=crop&w=800&q=80'
        },
        {
          id: 'eminonu_ferry',
          coords: [41.0167, 28.976],
          location: 'Eminönü Ferry Dock, Fatih',
          icon: {glyph:'⛴️', color:'#38bdf8'},
          title: 'Crossing the Waters',
          text: `Each day, thousands board the ferries from Eminönü, connecting two continents. The hustle, the simit sellers, and the anticipation of the crossing make this place a microcosm of Istanbul life.`,
          meta: 'Languages: TR • EN • Collected: Sep 2025 • Consent: public transit, wide angle',
          video: 'https://upload.wikimedia.org/wikipedia/commons/1/1c/Istanbul_ferry_crossing_Bosporus.webm'
        },
        {
          id: 'camlica_view',
          coords: [41.0245, 29.0717],
          location: 'Çamlıca Hill, Üsküdar',
          icon: {glyph:'🌄', color:'#16a34a'},
          title: 'Panorama from Çamlıca',
          text: `Çamlıca Hill offers a sweeping view over Istanbul. It’s a favorite for picnics, proposals, and quiet moments above the city’s busy noise.`,
          meta: 'Languages: TR • EN • Collected: Jul 2025 • Consent: public park, landscape',
          image: 'https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=800&q=80'
        },

        // New pins provided
        { id:'kumkapi', coords:[41.0019,28.9616], location:'Kumkapı Fish Market, Fatih', icon:{glyph:'🐟',color:'#4fd1c5'},
          title:'From Armenian Taverns to Syrian Seafood Stalls',
          text:`Kumkapı has long been a meeting point of cultures in Istanbul. In the early 20th century, the neighborhood was famous for its Armenian taverns, where mezes and music mixed with political debate. 

Since 2011, Syrian families have opened small seafood restaurants tucked between fish stalls. Their menus combine Levantine spices with the traditional Turkish meze spread. A waiter told us: “People come for the fish, but stay to talk.”`,
          meta:'Languages: TR • AR • HY • Collected: Mar 2025 • Consent: public space, no faces',
          ambient:[
            { label:'Seagulls', volume:0.35, loop:true, sources:[
              {src:'https://upload.wikimedia.org/wikipedia/commons/4/43/Gull_1.ogg', type:'audio/ogg'},
              {src:'https://upload.wikimedia.org/wikipedia/commons/transcoded/4/43/Gull_1.ogg/Gull_1.ogg.mp3?download=', type:'audio/mpeg'}
            ]},
            { label:'Waves', volume:0.25, loop:true, sources:[
              {src:'https://upload.wikimedia.org/wikipedia/commons/1/1f/Waves.ogg', type:'audio/ogg'},
              {src:'https://upload.wikimedia.org/wikipedia/commons/transcoded/1/1f/Waves.ogg/Waves.ogg.mp3?download=', type:'audio/mpeg'}
            ]},
            { label:'Restaurant ambience', volume:0.2, loop:true, sources:[
              {src:'https://upload.wikimedia.org/wikipedia/commons/b/b5/Restaurant_ambience.ogg', type:'audio/ogg'},
              {src:'https://upload.wikimedia.org/wikipedia/commons/transcoded/b/b5/Restaurant_ambience.ogg/Restaurant_ambience.ogg.mp3?download=', type:'audio/mpeg'}
            ]}
          ]
        },
        { id:'moda', coords:[40.9838,29.0252], location:'Moda Sahili, Kadıköy', icon:{glyph:'🌊',color:'#60a5fa'},
          title:'Where Languages Mix with the Sound of Waves',
          text:`On summer evenings, the Moda seaside becomes a gathering point for young Syrians, Kurds, Greeks, and expats. Conversations flow in Arabic, Turkish, English, and occasionally Greek. For many, the sound of waves is the only constant.`,
          meta:'Languages: TR • AR • EN • Collected: Apr 2025 • Consent: distant crowd photo',
          video:'https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.webm'
        },
        { id:'kurtulus', coords:[41.0536,28.9888], location:'Kurtuluş (Tatavla), Şişli', icon:{glyph:'🏘️',color:'#f59e0b'},
          title:'Layers of Memory in a Changing Neighborhood',
          text:`Known historically as Tatavla, Kurtuluş has long-standing Greek and Armenian roots. Today, it also hosts migrants from across Anatolia and the Middle East. Bakeries sell paskalya çöreği next to börek shops run by new arrivals.`,
          meta:'Languages: TR • HY • EN • Collected: Mar 2025 • Consent: interview excerpts anonymized',
          image:'https://picsum.photos/id/1062/800/480'
        },
        { id:'balat', coords:[41.0343,28.9497], location:'Balat, Fatih', icon:{glyph:'🏛️',color:'#c084fc'},
          title:'Between Heritage and Instagram',
          text:`Balat’s colorful facades attract visitors, but behind the photos are synagogues, churches, and long-standing Jewish, Greek, and Armenian histories. New cafes run by recent migrants add to the mix.`,
          meta:'Languages: TR • AR • legacy: HY • EL • Collected: Apr 2025 • Consent: no private interiors',
          image:'https://picsum.photos/id/1043/800/480'
        },
        { id:'uskudar', coords:[41.0257,29.0153], location:'Üsküdar İskele Meydanı', icon:{glyph:'🕌',color:'#34d399'},
          title:'Transit Square, Shared Rituals',
          text:`At ferry time, Üsküdar Square becomes a choreography of commuters, street vendors, and worshippers moving to and from nearby mosques and churches. Tea sellers switch languages with ease.`,
          meta:'Languages: TR • AR • EN • Collected: May 2025 • Consent: public space, wide shots only',
          image:'https://picsum.photos/id/1056/800/480'
        },
        { id:'karakoy_pier', coords:[41.0226,28.9784], location:'Karaköy İskelesi, Beyoğlu', icon:{glyph:'⛴️',color:'#22d3ee'},
          title:'Crossing Currents: Ferries, Fish, and Faith',
          text:`Between the pier and the fish stalls, Karaköy mixes office workers, tourists, and long-time residents. Calls to prayer blend with ferry announcements; seagulls circle above simit sellers.`,
          meta:'Languages: TR • EN • AR • Collected: May 2025 • Consent: public waterfront',
          video:'https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.webm'
        },
        { id:'spice_bazaar', coords:[41.0165,28.9704], location:'Mısır Çarşısı (Spice Bazaar), Eminönü', icon:{glyph:'🧂',color:'#f87171'},
          title:'Aromas and Accents under the Domes',
          text:`Vendors chant prices in Turkish and English, switching to Arabic or Russian when needed. Tourists bargain for saffron while locals pick up staples. The vaulted hall carries a constant murmur of voices.`,
          meta:'Languages: TR • EN • AR • RU • Collected: May 2025 • Consent: indoor public, wide shots',
          ambient:[
            { label:'Restaurant ambience', volume:0.25, loop:true, sources:[
              {src:'https://upload.wikimedia.org/wikipedia/commons/b/b5/Restaurant_ambience.ogg', type:'audio/ogg'},
              {src:'https://upload.wikimedia.org/wikipedia/commons/transcoded/b/b5/Restaurant_ambience.ogg/Restaurant_ambience.ogg.mp3?download=', type:'audio/mpeg'}
            ]}
          ]
        },
        { id:'besiktas_market', coords:[41.0430,29.0048], location:'Beşiktaş Çarşısı', icon:{glyph:'🧺',color:'#facc15'},
          title:'Morning Rush, Nighttime Cheers',
          text:`From fishmonger shouts to evening chants after a big match, Beşiktaş’s market streets are a study in daily rhythms. Students, workers, and fans share pavements; Kurdish bakeries and Greek tavernas operate side by side.`,
          meta:'Languages: TR • KU • EN • Collected: May 2025 • Consent: street scenes only',
          image:'https://picsum.photos/id/1003/800/480'
        }
      ];

      (function(){
        const map = L.map('map').setView([41.02,28.98], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        function makeIcon(spec) {
          const glyph = (spec && spec.glyph) || '📍';
          const color = (spec && spec.color) || '#e96e36';
          return L.divIcon({
            className:'ist-pin',
            html:`<div class="pin" style="--pin:${color}"><span class="glyph">${glyph}</span></div>`,
            iconSize:[36,44], iconAnchor:[18,44], popupAnchor:[0,-36]
          });
        }

        const markerById = new Map();
        pins.forEach(p => {
          let media = '';
          if (p.video) media += `<div style="margin:8px 0"><video controls preload="none" style="width:100%;max-height:220px"><source src="${p.video}">Your browser does not support the video tag.</video></div>`;
          if (p.image) media += `<div style="margin:8px 0"><img src="${p.image}" alt="${p.title}" style="width:100%;height:auto;border-radius:10px;display:block" loading="lazy"></div>`;

          let ambientUi = '';
          if (p.ambient && p.ambient.length) {
            const labels = p.ambient.map(t=>t.label).join(', ');
            ambientUi = `<div id="amb-${p.id}">
              <button class="btn-ambient" type="button">Play ambience</button>
              <div class="amb-note">Mix: ${labels}. Click to start. (Loops; stops on close.)</div>
              <div class="amb-audios" data-ready=""></div>
            </div>`;
          }

          const popupContent = `<h3 class="pin-title">${p.title}</h3>
            <div class="pin-body">${nl2br(p.text)}</div>
            ${media}${ambientUi}
            <div class="pin-meta"><b>Location:</b> ${p.location}<br>${p.meta}</div>`;

          const m = L.marker(p.coords, { icon: makeIcon(p.icon) }).addTo(map);
          m.bindPopup(popupContent);

          m.on('popupopen', (e)=>{
            if (!(p.ambient && p.ambient.length)) return;
            const root = e.popup._contentNode.querySelector(`#amb-${p.id}`); if (!root) return;
            const holder = root.querySelector('.amb-audios');
            if (!holder.dataset.ready) {
              p.ambient.forEach(tr => {
                const a = document.createElement('audio');
                a.preload='none'; a.loop=!!tr.loop; a.volume=(typeof tr.volume==='number'?tr.volume:0.3);
                a.crossOrigin='anonymous';
                (tr.sources||[]).forEach(s=>{
                  const src=document.createElement('source'); src.src=s.src; src.type=s.type; a.appendChild(src);
                });
                holder.appendChild(a);
              });
              holder.dataset.ready = "1";
            }
            const btn = root.querySelector('.btn-ambient');
            const audios = Array.from(holder.querySelectorAll('audio'));
            let playing=false;
            btn.onclick = async ()=>{
              try {
                if(!playing){ await Promise.all(audios.map(a=>a.play())); playing=true; btn.textContent='Pause ambience'; }
                else { audios.forEach(a=>a.pause()); playing=false; btn.textContent='Play ambience'; }
              } catch(e){}
            }
          });

          markerById.set(p.id, m);
        });

        // Sidebar pin list
        const list = document.getElementById('pinList');
        if (list) {
          list.innerHTML = '';
          pins.forEach((p, i) => {
            const el = document.createElement('div');
            el.className = 'card';
            el.innerHTML = `<div class="title">${i+1}. ${p.title}</div><div class="meta">${p.location}</div>`;
            el.onclick = () => {
              markerById.get(p.id).openPopup();
              map.setView(p.coords, 16, { animate: true, duration: .6 });
            };
            list.appendChild(el);
          });
        }

        // Fit bounds to pins
        if (pins.length > 1) {
          const group = new L.featureGroup([...markerById.values()]);
          map.fitBounds(group.getBounds().pad(0.2));
        }

        // Pause all audio/video on popup close
        map.on('popupclose', (e) => {
          const node = e.popup && e.popup._contentNode;
          if (!node) return;
          node.querySelectorAll('audio, video').forEach(el => {
            try { el.pause(); el.currentTime = 0; } catch(_) {}
          });
        });
      })();
    </script>
  </body>
</html>
